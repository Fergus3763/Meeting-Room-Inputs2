<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Tranche 4A.1 — Spaces Hotfix (Rooms + Assign Extras + Overrides)</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#f7fafc;color:#0f172a}
.container{max-width:1200px;margin:0 auto;padding:24px}
.card{background:#fff;border:1px solid #e2e8f0;border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);margin-bottom:16px}
.card-h{padding:14px 16px;border-bottom:1px solid #e2e8f0}
.card-c{padding:16px}
h1{margin:0 0 6px;font-size:20px}
h2{margin:0 0 8px;font-size:16px}
h3{margin:6px 0 6px}
.small{font-size:12px;color:#64748b}
label{display:block;font-size:13px;color:#334155;margin:8px 0 4px}
input,select,textarea{width:100%;border:1px solid #e2e8f0;border-radius:10px;padding:9px 11px}
textarea{min-height:86px}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
.grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
.grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media(max-width:1100px){.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}}
.table{width:100%;border-collapse:collapse;margin-top:8px}
.table th,.table td{border:1px solid #e2e8f0;padding:6px 8px;font-size:13px;vertical-align:top}
.table th{background:#f1f5f9;text-align:left}
.actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:1px solid #e2e8f0;background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
.btn.danger{border-color:#ef4444;color:#991b1b}
.badge{border:1px solid #e2e8f0;border-radius:999px;padding:4px 8px;font-size:12px;background:#fff;margin-left:6px}
.badge.ok{border-color:#bbf7d0;background:#f0fdf4;color:#166534}
.hr{height:1px;background:#e2e8f0;margin:12px 0}
.section{border:1px dashed #e2e8f0;border-radius:12px;padding:12px;margin-top:10px}
.item{display:grid;grid-template-columns:1fr 130px 110px;gap:10px;align-items:center;border-bottom:1px dashed #e2e8f0;padding:6px 0}
.item:last-child{border-bottom:none}
.pill{padding:4px 8px;border:1px solid #e2e8f0;border-radius:999px;font-size:12px}
.right{display:flex;justify-content:flex-end;gap:12px;align-items:center}
.totals{display:flex;gap:10px;flex-wrap:wrap}
.totalbox{border:1px solid #e2e8f0;background:#fff;border-radius:10px;padding:6px 10px;font-weight:600}
pre{background:#0b1220;color:#e5e7eb;padding:12px;border-radius:12px;max-height:360px;overflow:auto}
ul.clean{list-style:disc;margin-left:18px;padding-left:0}
.disabled input, .disabled select{opacity:.65;pointer-events:none}
.note{font-size:12px;color:#475569;margin-left:6px}
details>summary{cursor:pointer;font-weight:600;margin:4px 0 8px}
.summaryline{display:flex;gap:8px;align-items:center}
.tag{border:1px solid #e2e8f0;border-radius:999px;padding:2px 8px;font-size:12px;background:#fff}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="card-h">
      <h1>Tranche 4A.1 — Spaces Hotfix</h1>
      <div class="small">Guaranteed Rooms/Spaces UI + per-room assign extras & overrides, with AV hour/day pricing retained.</div>
    </div>
    <div class="card-c actions">
      <button class="btn" id="save">Save draft</button>
      <button class="btn" id="load">Load draft</button>
      <button class="btn" id="clear">Clear draft</button>
      <button class="btn" id="importJSON">Import JSON</button>
      <button class="btn primary" id="exportJSON">Export JSON</button>
      <span id="savedBadge" class="badge">Not saved</span>
    </div>
  </div>

  <div class="card">
    <div class="card-h"><h2>Copy / Terminology</h2></div>
    <div class="card-c grid grid-3">
      <div><label>Closing section title (booker)</label><input id="copyClosingTitle" value="Optional add-ons before checkout"/></div>
      <div><label>Per-category lead (booker)</label><input id="copyClosingLead" value="You may also add:"/></div>
    </div>
  </div>

  <div class="card">
    <div class="card-h"><h2>Venue tax/VAT</h2></div>
    <div class="card-c grid grid-3">
      <div><label>VAT rate (%)</label><input id="vatRate" type="number" step="0.01" value="20"></div>
      <div class="small">Used to compute Gross total for taxable items; untaxed items remain ex VAT.</div>
    </div>
  </div>

  <!-- SPACES -->
  <div class="card">
    <div class="card-h"><h2>Spaces (rooms)</h2></div>
    <div class="card-c">
      <div class="actions" style="margin-bottom:10px">
        <button class="btn" id="addRoomBtn">Add room</button>
      </div>
      <div id="roomsWrap"></div>
    </div>
  </div>

  <!-- CATEGORIES + ADD-ON EDITORS -->
  <div class="card">
    <div class="card-h"><h2>Categories with embedded editors</h2></div>
    <div class="card-c" id="catWrap"></div>
  </div>

  <!-- BOOKER PREVIEW -->
  <div class="card">
    <div class="card-h"><h2>Booker Flow Preview</h2></div>
    <div class="card-c">
      <div class="grid grid-4">
        <div><label>Room</label><select id="qRoom"></select></div>
        <div><label>Date</label><input id="qDate" type="date"></div>
        <div><label>Start</label><input id="qStart" type="time" value="09:00"></div>
        <div><label>End</label><input id="qEnd" type="time" value="12:00"></div>
        <div><label>Attendees</label><input id="qAtt" type="number" value="12" min="1"></div>
      </div>
      <div class="hr"></div>
      <div id="sections"></div>
      <div class="right" style="margin-top:10px">
        <div class="totals">
          <div class="totalbox" id="totEx">Total ex VAT: €0.00</div>
          <div class="totalbox" id="totVat">VAT: €0.00</div>
          <div class="totalbox" id="totInc">Total inc VAT: €0.00</div>
        </div>
      </div>
      <div class="actions" style="margin-top:10px"><button class="btn primary" id="goToCheckout">Continue</button></div>
      <div class="hr"></div>
      <h3 id="closingTitle" style="margin:0">Optional add-ons before checkout</h3>
      <div id="closingUpsell"></div>
      <div class="right" style="margin-top:10px">
        <button class="btn primary" id="recalc">Recalculate totals</button>
      </div>
      <div class="hr"></div>
      <div id="quoteOut"></div>
    </div>
  </div>

  <div class="card">
    <div class="card-h"><h2>Export Payload</h2></div>
    <div class="card-c"><pre id="preview"></pre></div>
  </div>
</div>

<script>
/* ---------- Data & defaults ---------- */
const DKEY="venue-tranche4a1-spaces-hotfix";
const defaultUnits={per_person:"person", per_item:"each", per_room:"room", per_hour:"hour", per_day:"day"};
const defaultLayouts = () => ({boardroom:12,u_shape:14,classroom:20,theatre:40,cabaret:24,banquet:30,hollow_square:16,reception:50,exam:20,otherName:"",otherCapacity:0});
const defaultFeatures = () => ({
  naturalLight:true, windowsOpen:false, blackoutBlinds:true, airCon:true, heating:true,
  stepFree:true, accessibleWCNearby:true, inRoomWC:false, pillarFree:true,
  soundTreated:false, acousticCeiling:true, ceilingHeightM:3,
  externalNoise:"low", freshAir:true, view:"none", outdoorAccess:false, terrace:false,
  privateEntrance:false, adjacentBreakout:true,
  builtInProjector:true, builtInScreen:true, builtInSpeakers:true,
  hdmiAtTable:true, powerOutletsMany:true, power3Phase:false,
  wiredInternet:true, ups:false, whiteboardWall:true, writeableWall:false,
  moveablePartitions:false, storage:false, cloakRail:true, fridge:false,
  waterStation:true, coffeePoint:false, lightingPresets:true, dimmableLights:true,
  decorativeLighting:false, artwork:false, plants:false
});
const defaultConstraints = () => ({minMinutes:60, earliestStart:"07:00", latestEnd:"22:00", setupMin:30, teardownMin:30, leadTimeHours:24, cutoffHours:2});

const data={
  vatRate:20,
  copy:{closingTitle:"Optional add-ons before checkout", closingLead:"You may also add:"},
  categories:[
    {id:"CAT-FNB", name:"Food & Beverage", sectionLabel:"F&B", sort:10, showClosingUpsell:true, standards:[{id:"STD-FIL", name:"Filtered water on the table"}]},
    {id:"CAT-AV", name:"Audio/Visual", sectionLabel:"AV", sort:20, showClosingUpsell:true, standards:[{id:"STD-WIFI", name:"Wi-Fi included"}]}
  ],
  extras:[
    {id:"ADD-COF", pricingMode:"simple", name:"Coffee & Tea (refills)", categoryId:"CAT-FNB", priceType:"per_person", unitName:"person", priceExVAT:4.5, taxable:true, minQty:0, maxQty:0, step:1, defaultSelected:false, leadTimeHours:0, cutoffHours:0, showInMain:true, offerAtClosing:true, visibility:"public", publicLabel:"Coffee & Tea"},
    {id:"ADD-PTZ", pricingMode:"hour_or_day", name:"PTZ Camera Kit", categoryId:"CAT-AV", ratePerHourExVAT:60, ratePerDayExVAT:180, dayCapHours:4, roundHoursUp:true, taxable:true, minQty:0, maxQty:1, step:1, defaultSelected:false, leadTimeHours:24, cutoffHours:2, showInMain:true, offerAtClosing:true, visibility:"public", publicLabel:"PTZ Camera Kit"}
  ],
  rooms:[]
};

/* Safety: always ensure at least one room exists */
function ensureAtLeastOneRoom(){
  if(!Array.isArray(data.rooms)) data.rooms=[];
  if(data.rooms.length===0){
    data.rooms.push({
      id:"RM-HARBOUR", name:"Harbour Room", description:"Bright room with water views.",
      sizeSqm:50, floor:"1",
      layouts: defaultLayouts(),
      features: Object.assign(defaultFeatures(), {view:"water"}),
      images:{hero:"", gallery:[]},
      constraints: defaultConstraints(),
      blackouts:[{start:"2025-12-24", end:"2025-12-26", reason:"Christmas"}],
      includedItems:[{name:"Flipchart", qty:1}],
      assignedExtras:[
        {extraId:"ADD-COF", enabled:true, overrides:{}},
        {extraId:"ADD-PTZ", enabled:true, overrides:{}}
      ]
    });
  }
}

/* ---------- Helpers ---------- */
function $(id){return document.getElementById(id)}
function saved(state){const b=$("savedBadge"); b.textContent = state ? "Saved" : "Not saved"; b.className = "badge" + (state ? " ok": "");}
function updatePreview(){ $("preview").textContent = JSON.stringify(data,null,2); saved(false); buildRoomSelect(); buildSections(); calcTotalsLive(); }
function toMin(t){ if(!t) return 0; const [h,m]=t.split(":").map(Number); return h*60+(m||0); }
function getRoomById(id){ return (data.rooms||[]).find(r=>r.id===id); }
function isAV(cat){ const s=(cat.id+" "+cat.name+" "+(cat.sectionLabel||"")).toLowerCase(); return /(^|[^a-z])(av|audio|visual|a\/v)([^a-z]|$)/.test(s); }
function td(node){ const d=document.createElement("td"); d.append(node); return d; }
function numberInput(val,cb){ const i=document.createElement("input"); i.type="number"; i.value=(val??""); i.oninput=()=>cb(Number(i.value||0)); return i; }
function textInput(val,cb){ const i=document.createElement("input"); i.value=(val??""); i.oninput=()=>cb(i.value); return i; }
function boolInput(val,cb){ const i=document.createElement("input"); i.type="checkbox"; i.checked=!!val; i.onchange=()=>cb(i.checked); return i; }
function selectInput(val,opts,cb){ const s=document.createElement("select"); opts.forEach(o=>s.append(new Option(o.text||o,o.value||o))); s.value=val; s.onchange=()=>cb(s.value); return s; }

/* ---------- Rooms UI ---------- */
function renderRooms(){
  const wrap=$("roomsWrap"); if(!wrap) return;
  wrap.innerHTML="";
  ensureAtLeastOneRoom();

  (data.rooms||[]).forEach((room,idx)=>{
    const det=document.createElement("details"); det.open = idx===0;
    const sum=document.createElement("summary");
    const tag1=document.createElement("span"); tag1.className="tag"; tag1.textContent=room.id;
    const tag2=document.createElement("span"); tag2.className="tag"; tag2.textContent=(room.layouts?.boardroom??0)+" boardroom";
    sum.className="summaryline";
    sum.innerHTML=`<span><strong>${room.name||"(unnamed room)"}</strong></span>`;
    sum.append(tag1, tag2);
    det.append(sum);

    const sec=document.createElement("div"); sec.className="section";

    /* Basics */
    const basics=document.createElement("div"); basics.className="grid grid-4";
    const b1=document.createElement("div"); b1.innerHTML="<label>Room ID</label>"; const b1i=textInput(room.id, v=>{room.id=v; updatePreview();}); b1.append(b1i);
    const b2=document.createElement("div"); b2.innerHTML="<label>Room name</label>"; const b2i=textInput(room.name, v=>{room.name=v; updatePreview();}); b2.append(b2i);
    const b3=document.createElement("div"); b3.innerHTML="<label>Floor</label>"; const b3i=textInput(room.floor||"", v=>{room.floor=v; updatePreview();}); b3.append(b3i);
    const b4=document.createElement("div"); b4.innerHTML="<label>Size (sqm)</label>"; const b4i=numberInput(room.sizeSqm||0, v=>{room.sizeSqm=v; updatePreview();}); b4.append(b4i);
    const b5=document.createElement("div"); b5.className="grid-4"; b5.innerHTML="<label>Description</label>";
    const b5i=document.createElement("textarea"); b5i.value=room.description||""; b5i.oninput=()=>{room.description=b5i.value; updatePreview();}; b5.append(b5i); b5.style.gridColumn="1/-1";
    basics.append(b1,b2,b3,b4,b5); sec.append(basics);

    /* Layouts */
    room.layouts = room.layouts || defaultLayouts();
    const lay=document.createElement("div"); lay.className="section"; lay.innerHTML="<h3>Layouts & capacities</h3>";
    const layoutTable=document.createElement("table"); layoutTable.className="table";
    const rows=[["Boardroom","boardroom"],["U-Shape","u_shape"],["Classroom","classroom"],["Theatre","theatre"],["Cabaret","cabaret"],["Banquet","banquet"],["Hollow-square","hollow_square"],["Reception","reception"],["Exam","exam"]];
    layoutTable.innerHTML=`<thead><tr><th>Layout</th><th>Capacity</th></tr></thead><tbody></tbody>`;
    const ltb=layoutTable.querySelector("tbody");
    rows.forEach(([label,key])=>{
      const tr=document.createElement("tr");
      tr.append(td(document.createTextNode(label)));
      const cap=numberInput(room.layouts[key]||0, v=>{room.layouts[key]=v; updatePreview();});
      tr.append(td(cap)); ltb.append(tr);
    });
    const tr=document.createElement("tr");
    const otherName=textInput(room.layouts.otherName||"", v=>{room.layouts.otherName=v; updatePreview();});
    const otherCap=numberInput(room.layouts.otherCapacity||0, v=>{room.layouts.otherCapacity=v; updatePreview();});
    tr.append(td(otherName), td(otherCap)); ltb.append(tr);
    lay.append(layoutTable); sec.append(lay);

    /* Features checklist */
    room.features = room.features || defaultFeatures();
    const f=document.createElement("div"); f.className="section"; f.innerHTML="<h3>Features</h3>";
    const fg=document.createElement("div"); fg.className="grid grid-4";
    function featBool(label,key){ const d=document.createElement("div"); d.innerHTML=`<label>${label}</label>`; d.append(boolInput(!!room.features[key], v=>{room.features[key]=v; updatePreview();})); fg.append(d); }
    function featNum(label,key,step=0.1){ const d=document.createElement("div"); d.innerHTML=`<label>${label}</label>`; const i=document.createElement("input"); i.type="number"; i.step=step; i.value=room.features[key]??""; i.oninput=()=>{room.features[key]=Number(i.value||0); updatePreview();}; d.append(i); fg.append(d); }
    function featSel(label,key,opts){ const d=document.createElement("div"); d.innerHTML=`<label>${label}</label>`; d.append(selectInput(room.features[key]||opts[0], opts, v=>{room.features[key]=v; updatePreview();})); fg.append(d); }
    featBool("Natural light","naturalLight"); featBool("Windows can open","windowsOpen"); featBool("Blackout blinds","blackoutBlinds"); featBool("Air-conditioning","airCon"); featBool("Heating","heating");
    featBool("Step-free access","stepFree"); featBool("Accessible WC nearby","accessibleWCNearby"); featBool("In-room WC","inRoomWC"); featBool("Pillar-free","pillarFree");
    featBool("Sound-treated/quiet","soundTreated"); featBool("Acoustic ceiling","acousticCeiling"); featNum("Ceiling height (m)","ceilingHeightM",0.1);
    featSel("External noise risk","externalNoise",["low","medium","high"]); featBool("Fresh-air (HVAC)","freshAir"); featSel("View","view",["none","city","park","water","mountain"]);
    featBool("Outdoor access","outdoorAccess"); featBool("Terrace/Balcony","terrace"); featBool("Private entrance","privateEntrance"); featBool("Adjacent breakout space","adjacentBreakout");
    featBool("Built-in projector","builtInProjector"); featBool("Built-in screen","builtInScreen"); featBool("Built-in speakers","builtInSpeakers"); featBool("HDMI at table","hdmiAtTable");
    featBool("Multiple power outlets","powerOutletsMany"); featBool("3-phase power","power3Phase"); featBool("Wired internet port","wiredInternet"); featBool("UPS/backup power","ups");
    featBool("Whiteboard wall","whiteboardWall"); featBool("Writable flip wall","writeableWall"); featBool("Moveable partitions","moveablePartitions"); featBool("In-room storage","storage");
    featBool("Cloak rail","cloakRail"); featBool("Fridge","fridge"); featBool("Water station","waterStation"); featBool("Coffee point","coffeePoint");
    featBool("Lighting presets","lightingPresets"); featBool("Dimmable lights","dimmableLights"); featBool("Decorative lighting","decorativeLighting"); featBool("Artwork","artwork"); featBool("Plants","plants");
    f.append(fg); sec.append(f);

    /* Images */
    room.images = room.images || {hero:"", gallery:[]};
    const im=document.createElement("div"); im.className="section"; im.innerHTML="<h3>Images</h3>";
    const imGrid=document.createElement("div"); imGrid.className="grid grid-3";
    const hero=document.createElement("div"); hero.innerHTML="<label>Hero image URL</label>";
    const heroI=textInput(room.images.hero||"", v=>{room.images.hero=v; updatePreview();}); hero.append(heroI);
    const gal=document.createElement("div"); gal.innerHTML="<label>Gallery URLs (comma-separated)</label>";
    const galI=textInput((room.images.gallery||[]).join(", "), v=>{room.images.gallery=v.split(',').map(s=>s.trim()).filter(Boolean); updatePreview();}); gal.append(galI);
    imGrid.append(hero, gal); im.append(imGrid); sec.append(im);

    /* Constraints */
    room.constraints = room.constraints || defaultConstraints();
    const cons=document.createElement("div"); cons.className="section"; cons.innerHTML="<h3>Constraints & timing</h3>";
    const cgrid=document.createElement("div"); cgrid.className="grid grid-4";
    function cNum(label,key){ const d=document.createElement("div"); d.innerHTML=`<label>${label}</label>`; const i=numberInput(room.constraints[key]||0, v=>{room.constraints[key]=v; updatePreview();}); d.append(i); cgrid.append(d); }
    function cText(label,key,type="time"){ const d=document.createElement("div"); d.innerHTML=`<label>${label}</label>`; const i=document.createElement("input"); i.type=type; i.value=room.constraints[key]||""; i.oninput=()=>{room.constraints[key]=i.value; updatePreview();}; d.append(i); cgrid.append(d); }
    cNum("Min duration (minutes)","minMinutes"); cText("Earliest start","earliestStart"); cText("Latest end","latestEnd");
    cNum("Setup buffer (min)","setupMin"); cNum("Teardown buffer (min)","teardownMin");
    cNum("Lead time (hours)","leadTimeHours"); cNum("Cut-off (hours)","cutoffHours");
    cons.append(cgrid); sec.append(cons);

    /* Blackouts */
    room.blackouts = room.blackouts || [];
    const bo=document.createElement("div"); bo.className="section"; bo.innerHTML="<h3>Blackouts</h3>";
    const bot=document.createElement("table"); bot.className="table";
    bot.innerHTML=`<thead><tr><th>Start date</th><th>End date</th><th>Reason</th><th></th></tr></thead><tbody></tbody>`;
    const bob=bot.querySelector("tbody");
    room.blackouts.forEach((b,bi)=>{
      const tr=document.createElement("tr");
      const s=document.createElement("input"); s.type="date"; s.value=b.start||""; s.oninput=()=>{b.start=s.value; updatePreview();};
      const e=document.createElement("input"); e.type="date"; e.value=b.end||""; e.oninput=()=>{b.end=e.value; updatePreview();};
      const r=textInput(b.reason||"", v=>{b.reason=v; updatePreview();});
      const del=document.createElement("button"); del.className="btn danger"; del.textContent="Delete"; del.onclick=()=>{room.blackouts.splice(bi,1); renderRooms(); updatePreview();};
      tr.append(td(s),td(e),td(r),td(del)); bob.append(tr);
    });
    const addBo=document.createElement("button"); addBo.className="btn"; addBo.textContent="Add blackout"; addBo.onclick=()=>{room.blackouts.push({start:"",end:"",reason:""}); renderRooms(); updatePreview();};
    bo.append(bot, addBo); sec.append(bo);

    /* Included items */
    room.includedItems = room.includedItems || [];
    const inc=document.createElement("div"); inc.className="section"; inc.innerHTML="<h3>Included items (non-priced)</h3>";
    const incT=document.createElement("table"); incT.className="table"; incT.innerHTML=`<thead><tr><th>Name</th><th>Qty</th><th></th></tr></thead><tbody></tbody>`;
    const incB=incT.querySelector("tbody");
    room.includedItems.forEach((it,ii)=>{
      const tr=document.createElement("tr");
      const n=textInput(it.name||"", v=>{it.name=v; updatePreview();});
      const q=numberInput(it.qty||0, v=>{it.qty=v; updatePreview();});
      const del=document.createElement("button"); del.className="btn danger"; del.textContent="Delete"; del.onclick=()=>{room.includedItems.splice(ii,1); renderRooms(); updatePreview();};
      tr.append(td(n),td(q),td(del)); incB.append(tr);
    });
    const addInc=document.createElement("button"); addInc.className="btn"; addInc.textContent="Add included item"; addInc.onclick=()=>{room.includedItems.push({name:"",qty:1}); renderRooms(); updatePreview();};
    inc.append(incT, addInc); sec.append(inc);

    /* Assign extras with per-room overrides */
    room.assignedExtras = room.assignedExtras || [];
    const assign=document.createElement("div"); assign.className="section"; assign.innerHTML="<h3>Extras for this room (enable & optional overrides)</h3>";
    const aT=document.createElement("table"); aT.className="table";
    aT.innerHTML=`<thead><tr><th>Enabled</th><th>Extra</th><th>Pricing</th><th>Overrides</th></tr></thead><tbody></tbody>`;
    const aB=aT.querySelector("tbody");
    (data.extras||[]).forEach(ex=>{
      let row = room.assignedExtras.find(a=>a.extraId===ex.id);
      if(!row){ row={extraId:ex.id, enabled:false, overrides:{}}; room.assignedExtras.push(row); }
      const tr=document.createElement("tr");
      const enabled=boolInput(!!row.enabled, v=>{row.enabled=v; updatePreview();});
      const label=document.createElement("div"); label.textContent = (ex.publicLabel||ex.name||ex.id);
      const pricing=document.createElement("div");
      if(ex.pricingMode==="hour_or_day"){
        pricing.textContent = `Hour/Day • €${ex.ratePerHourExVAT||0}/hr or €${ex.ratePerDayExVAT||0}/day (cap ${ex.dayCapHours||8}h)`;
      }else{
        pricing.textContent = `Simple • €${ex.priceExVAT||0} per ${ex.unitName||"unit"}`;
      }
      const ov=document.createElement("div");
      if(ex.pricingMode==="hour_or_day"){
        ov.innerHTML = `
          <div class="grid grid-3">
            <div><label>Rate/hr (override)</label><input type="number" step="0.01" value="${row.overrides.ratePerHourExVAT??""}"></div>
            <div><label>Rate/day (override)</label><input type="number" step="0.01" value="${row.overrides.ratePerDayExVAT??""}"></div>
            <div><label>Day cap hrs (override)</label><input type="number" step="1" value="${row.overrides.dayCapHours??""}"></div>
          </div>`;
        const [i1,i2,i3]=ov.querySelectorAll("input");
        i1.oninput=()=>{row.overrides.ratePerHourExVAT=Number(i1.value||0); updatePreview();};
        i2.oninput=()=>{row.overrides.ratePerDayExVAT=Number(i2.value||0); updatePreview();};
        i3.oninput=()=>{row.overrides.dayCapHours=Number(i3.value||0); updatePreview();};
      }else{
        ov.innerHTML = `<label>Price ex VAT (override)</label><input type="number" step="0.01" value="${row.overrides.priceExVAT??""}">`;
        const i=ov.querySelector("input"); i.oninput=()=>{row.overrides.priceExVAT=Number(i.value||0); updatePreview();};
      }
      tr.append(td(enabled), td(label), td(pricing), td(ov)); aB.append(tr);
    });
    assign.append(aT); sec.append(assign);

    // delete room
    const del=document.createElement("button"); del.className="btn danger"; del.textContent="Delete room";
    del.onclick=()=>{ if(confirm("Delete room '"+(room.name||room.id)+"'?")){ data.rooms.splice(idx,1); renderRooms(); buildRoomSelect(); updatePreview(); } };
    sec.append(del);

    det.append(sec); wrap.append(det);
  });
}

/* ---------- Categories + add-ons editor ---------- */
function renderCategories(){
  const wrap=$("catWrap"); if(!wrap) return; wrap.innerHTML="";
  const cats=[...data.categories].sort((a,b)=> (a.sort||0)-(b.sort||0));
  cats.forEach(cat=>{
    const card=document.createElement("div"); card.className="section";
    const head=document.createElement("div"); head.className="actions"; head.innerHTML=`<div><strong>${cat.sectionLabel||cat.name}</strong> <span class="pill">ID ${cat.id}</span> ${isAV(cat) ? "<span class='small'>(New add-ons default to Hour/Day here)</span>" : ""}</div>`;
    card.append(head);

    const basics=document.createElement("div"); basics.className="grid grid-3";
    function inp(label, val, cb){ const w=document.createElement("div"); w.innerHTML=`<label>${label}</label>`; const i=document.createElement("input"); i.value=val||""; i.oninput=()=>{cb(i.value); updatePreview();}; w.append(i); return w; }
    function num(label, val, cb){ const w=document.createElement("div"); w.innerHTML=`<label>${label}</label>`; const i=document.createElement("input"); i.type="number"; i.value=val||0; i.oninput=()=>{cb(Number(i.value||0)); updatePreview();}; w.append(i); return w; }
    function bool(label, val, cb){ const w=document.createElement("div"); w.innerHTML=`<label>${label}</label>`; const i=document.createElement("input"); i.type="checkbox"; i.checked=!!val; i.onchange=()=>{cb(i.checked); updatePreview();}; w.append(i); return w; }
    basics.append(inp("Name", cat.name, v=>cat.name=v), inp("Booker label", cat.sectionLabel, v=>cat.sectionLabel=v), num("Sort order", cat.sort, v=>cat.sort=v), bool("Show at closing?", cat.showClosingUpsell, v=>cat.showClosingUpsell=v));
    card.append(basics);

    const std=document.createElement("div"); std.className="section"; std.innerHTML="<h4>Standards (included, non-priced)</h4>";
    const stdList=document.createElement("ul"); stdList.className="clean";
    (cat.standards=cat.standards||[]).forEach((s,si)=>{
      const li=document.createElement("li");
      const name=document.createElement("input"); name.style.width="60%"; name.value=s.name||""; name.oninput=()=>{s.name=name.value; updatePreview();};
      const del=document.createElement("button"); del.className="btn danger"; del.textContent="Delete"; del.onclick=()=>{cat.standards.splice(si,1); renderCategories(); updatePreview();};
      li.append(name, del); stdList.append(li);
    });
    const addStd=document.createElement("button"); addStd.className="btn"; addStd.textContent="Add standard"; addStd.onclick=()=>{ (cat.standards=cat.standards||[]).push({id:"STD-"+Math.random().toString(36).slice(2,6).toUpperCase(), name:""}); renderCategories(); updatePreview(); };
    std.append(stdList, addStd); card.append(std);

    const addons=document.createElement("div"); addons.className="section"; addons.innerHTML="<h4>Add-ons (booker-facing options)</h4>";
    const table=document.createElement("table"); table.className="table";
    table.innerHTML=`<thead><tr>
      <th>ID</th><th>Name</th><th>Pricing mode</th><th>Price type</th><th>Unit</th><th>Price ex VAT</th>
      <th>Rate/hr</th><th>Rate/day</th><th>Day cap (hrs)</th><th>Round hours up?</th>
      <th>Taxable?</th><th>Min</th><th>Max</th><th>Step</th><th>Default?</th><th>LeadH</th><th>CutoffH</th>
      <th>Show in main?</th><th>Offer at closing?</th><th>Visibility</th><th>Public Label</th><th></th>
    </tr></thead><tbody></tbody>`;
    const tb=table.querySelector("tbody");
    const priceTypes=["per_person","per_item","per_room","per_hour","per_day"];
    const visOpts=["public","hidden","public_aggregate"];
    (data.extras||[]).filter(x=>x.categoryId===cat.id).forEach((row)=>{
      function inp(val, cb, type="text"){ const i=document.createElement("input"); if(type==="number"){i.type="number"; i.step="0.01"}; i.value=val??""; i.oninput=()=>{ cb(type==="number"? Number(i.value||0): i.value); updatePreview();}; return i; }
      function bool(val, cb){ const i=document.createElement("input"); i.type="checkbox"; i.checked=!!val; i.onchange=()=>{ cb(i.checked); updatePreview();}; return i; }
      function sel(val, opts, cb){ const s=document.createElement("select"); opts.forEach(o=>s.append(new Option(o,o))); s.value=val||opts[0]; s.onchange=()=>{ cb(s.value); updatePreview();}; return s; }

      const tr=document.createElement("tr");
      const idCell = inp(row.id, v=>row.id=v);
      const nameCell = inp(row.name, v=>row.name=v);
      const modeSel = sel(row.pricingMode|| (isAV(cat) ? "hour_or_day" : "simple"), ["simple","hour_or_day"], v=>{ row.pricingMode=v; refreshRowState(); });
      const priceTypeSel = sel(row.priceType||"per_item", priceTypes, v=>{ row.priceType=v; if(!row.unitName || Object.values(defaultUnits).includes(row.unitName)) { row.unitName = defaultUnits[v]||""; unitInp.value=row.unitName; } });
      const unitInp = inp(row.unitName||defaultUnits[row.priceType]||"", v=>row.unitName=v);
      const priceInp = inp(row.priceExVAT||0, v=>row.priceExVAT=v, "number");
      const rateHrInp = inp(row.ratePerHourExVAT||0, v=>row.ratePerHourExVAT=v, "number");
      const rateDayInp = inp(row.ratePerDayExVAT||0, v=>row.ratePerDayExVAT=v, "number");
      const capInp = inp(row.dayCapHours||8, v=>row.dayCapHours=v, "number");
      const roundInp = bool(row.roundHoursUp!==false, v=>row.roundHoursUp=v);
      const taxable = bool(row.taxable, v=>row.taxable=v);
      const minInp = inp(row.minQty||0, v=>row.minQty=v,"number");
      const maxInp = inp(row.maxQty||0, v=>row.maxQty=v,"number");
      const stepInp = inp(row.step||1, v=>row.step=v,"number");
      const defInp = bool(row.defaultSelected, v=>row.defaultSelected=v);
      const leadInp = inp(row.leadTimeHours||0, v=>row.leadTimeHours=v,"number");
      const cutInp = inp(row.cutoffHours||0, v=>row.cutoffHours=v,"number");
      const showMain = bool(row.showInMain!==false, v=>row.showInMain=v);
      const offerClose = bool(row.offerAtClosing!==false, v=>row.offerAtClosing=v);
      const visSel = sel(row.visibility||"public", visOpts, v=>row.visibility=v);
      const pubLbl = inp(row.publicLabel||"", v=>row.publicLabel=v);
      const del=document.createElement("button"); del.className="btn danger"; del.textContent="Delete"; del.onclick=()=>{ const idx=data.extras.findIndex(e=>e.id===row.id); if(idx>=0){data.extras.splice(idx,1);} renderCategories(); buildSections(); updatePreview(); };

      function refreshRowState(){
        const simple = (row.pricingMode!=="hour_or_day");
        [priceTypeSel, unitInp, priceInp].forEach(el=>{ el.disabled = !simple; el.parentElement && el.parentElement.classList.toggle("disabled", !simple); });
        [rateHrInp, rateDayInp, capInp, roundInp].forEach(el=>{ el.disabled = simple; el.parentElement && el.parentElement.classList.toggle("disabled", simple); });
      }
      tr.append(td(idCell), td(nameCell), td(modeSel), td(priceTypeSel), td(unitInp), td(priceInp), td(rateHrInp), td(rateDayInp), td(capInp), td(roundInp), td(taxable), td(minInp), td(maxInp), td(stepInp), td(defInp), td(leadInp), td(cutInp), td(showMain), td(offerClose), td(visSel), td(pubLbl), td(del));
      tb.append(tr); refreshRowState();
    });
    const addBtn=document.createElement("button"); addBtn.className="btn"; addBtn.textContent="Add add-on in this category";
    addBtn.onclick=()=>{
      const defaultMode = isAV(cat) ? "hour_or_day" : "simple";
      (data.extras=data.extras||[]).push({
        id:"ADD-"+Math.random().toString(36).slice(2,6).toUpperCase(),
        pricingMode: defaultMode, name:"", categoryId:cat.id,
        priceType:"per_item", unitName:defaultUnits["per_item"],
        priceExVAT:0, ratePerHourExVAT:0, ratePerDayExVAT:0, dayCapHours:8, roundHoursUp:true,
        taxable:true, minQty:0, maxQty:0, step:1, defaultSelected:false, leadTimeHours:0, cutoffHours:0, showInMain:true, offerAtClosing:true, visibility:"public", publicLabel:""
      });
      renderCategories(); buildSections(); updatePreview();
    };
    addons.append(table, addBtn); card.append(addons); wrap.append(card);
  });
}

/* ---------- Booker preview ---------- */
function buildRoomSelect(){
  const sel=$("qRoom"); if(!sel) return;
  const lastVal=sel.value;
  sel.innerHTML="";
  (data.rooms||[]).forEach(r=> sel.append(new Option(r.name||r.id, r.id)));
  sel.value = lastVal && getRoomById(lastVal) ? lastVal : (data.rooms?.[0]?.id || "");
}
function assignedForRoom(room){ const map=new Map(); (room.assignedExtras||[]).forEach(a=> map.set(a.extraId, a)); return map; }
function buildSections(){
  const wrap=$("sections"); if(!wrap) return; wrap.innerHTML="";
  const room = getRoomById($("qRoom").value); if(!room){ wrap.innerHTML="<div class='small'>Add a room first.</div>"; return; }
  const enabled = assignedForRoom(room);
  const cats=[...data.categories].sort((a,b)=> (a.sort||0)-(b.sort||0));
  cats.forEach(cat=>{
    const sec=document.createElement("div"); sec.className="section";
    const h=document.createElement("h3"); h.textContent=(cat.sectionLabel||cat.name)+" — Add-ons"; sec.append(h);
    const items=(data.extras||[])
      .filter(x=>x.categoryId===cat.id && x.showInMain!==false && (x.visibility||"public")!=="hidden")
      .filter(x=> enabled.get(x.id)?.enabled);
    if(items.length===0){ const em=document.createElement("div"); em.className="small"; em.textContent="No add-ons in this section for this room."; sec.append(em); wrap.append(sec); return; }
    items.forEach(x=>{
      const roomAssign = enabled.get(x.id) || {overrides:{}};
      const ov = roomAssign.overrides || {};
      const row=document.createElement("div"); row.className="item";
      const modeText = (x.pricingMode==="hour_or_day") ? "hour/day" : (x.priceType||"");
      const label=document.createElement("div"); label.innerHTML="<strong>"+(x.publicLabel||x.name||x.id)+"</strong> <span class='small'>("+modeText+")</span>";
      const qty=document.createElement("input"); qty.type="number"; qty.step=x.step||1; qty.min=x.minQty||0; qty.max=x.maxQty||99999; qty.value = x.defaultSelected ? Math.max((x.minQty||0),(x.step||1)) : 0; qty.id="sel-extra-"+x.id; qty.oninput=calcTotalsLive;
      const price=document.createElement("div"); price.className="small";
      if(x.pricingMode==="hour_or_day"){
        const rph = (ov.ratePerHourExVAT ?? x.ratePerHourExVAT) || 0;
        const rpd = (ov.ratePerDayExVAT ?? x.ratePerDayExVAT) || 0;
        const cap = (ov.dayCapHours ?? x.dayCapHours) || 8;
        price.textContent = "€"+rph+"/hour or €"+rpd+"/day (cap "+cap+"h)";
      }else{
        const p = (ov.priceExVAT ?? x.priceExVAT) || 0;
        price.textContent = "€"+p+" / "+(x.unitName||"unit");
      }
      row.append(label, qty, price); sec.append(row);
    });
    wrap.append(sec);
  });
}
function collectSelected(){ const s=[]; (data.extras||[]).forEach(x=>{ const el=document.getElementById("sel-extra-"+x.id); const v=Number(el?.value||0); if(v>0) s.push(Object.assign({}, x, {qty:v}));}); return s; }
function priceLines(arr){
  const start=$("qStart").value||"09:00", end=$("qEnd").value||"10:00"; let hours=Math.max(1,(toMin(end)-toMin(start))/60);
  const attendees=Number($("qAtt").value||0);
  const room = getRoomById($("qRoom").value);
  const enabled = assignedForRoom(room);
  const lines=[];
  (arr||[]).forEach(x=>{
    const assign = enabled.get(x.id) || {overrides:{}};
    if(!assign.enabled) return;
    const ov = assign.overrides||{};
    let qty=x.qty||0; if(qty<=0) return;
    let ex=0, basis="", unitPriceDisp=0, unitNameDisp=x.unitName||"";
    if(x.pricingMode==="hour_or_day"){
      const hrRate = Number(ov.ratePerHourExVAT ?? x.ratePerHourExVAT ?? 0);
      const dayRate = Number(ov.ratePerDayExVAT ?? x.ratePerDayExVAT ?? 0);
      const cap = Number(ov.dayCapHours ?? x.dayCapHours ?? 8);
      let h = hours; if(x.roundHoursUp!==false){ h = Math.ceil(h); }
      if(h >= cap && dayRate>0){ ex = dayRate * qty; basis = "day rate"; unitPriceDisp = dayRate; unitNameDisp = "day"; }
      else { ex = hrRate * h * qty; basis = "hourly × "+h+"h"; unitPriceDisp = hrRate; unitNameDisp = "hour"; }
    }else{
      const unit = Number(ov.priceExVAT ?? x.priceExVAT ?? 0);
      let mult=1;
      if(x.priceType==="per_person") mult = attendees * qty;
      else if(x.priceType==="per_item") mult = qty;
      else if(x.priceType==="per_room") mult = qty;
      else if(x.priceType==="per_hour") mult = Math.max(1,hours) * qty;
      else if(x.priceType==="per_day") mult = qty;
      ex = unit * mult; basis = x.priceType||""; unitPriceDisp = unit;
    }
    const vat = (x.taxable? (ex * (Number(data.vatRate||0)/100)) : 0);
    lines.push({label:x.publicLabel||x.name||x.id, qty, unitName:unitNameDisp, unitPrice:unitPriceDisp, basis, exVAT:ex, vat, incVAT: ex+vat});
  });
  return lines;
}
function sumTotals(lines){ return lines.reduce((a,l)=>{ a.ex+=l.exVAT; a.vat+=l.vat; a.inc+=l.incVAT; return a; }, {ex:0, vat:0, inc:0}); }
function calcTotalsLive(){ const lines=priceLines(collectSelected()); const t=sumTotals(lines); $("totEx").textContent="Total ex VAT: €"+t.ex.toFixed(2); $("totVat").textContent="VAT: €"+t.vat.toFixed(2); $("totInc").textContent="Total inc VAT: €"+t.inc.toFixed(2); }
["qRoom","qDate","qStart","qEnd","qAtt","vatRate"].forEach(id=>{ const el=document.getElementById(id); if(el) el.oninput=()=>{ if(id==="vatRate"){ data.vatRate=Number(el.value||0);} buildSections(); calcTotalsLive(); }; });

function goToCheckout(){
  const selected=collectSelected();
  const room=getRoomById($("qRoom").value);
  const enabled=assignedForRoom(room);
  const selectedIds=new Set(selected.map(s=>s.id));
  const closing=$("closingUpsell"); closing.innerHTML="";
  const cats=[...data.categories].sort((a,b)=> (a.sort||0)-(b.sort||0));
  cats.forEach(cat=>{
    const ups=(data.extras||[]).filter(x=> x.categoryId===cat.id && (x.visibility||"public")!=="hidden" && x.offerAtClosing!==false && !selectedIds.has(x.id) && (enabled.get(x.id)?.enabled));
    if(!ups.length) return;
    const sec=document.createElement("div"); sec.className="section"; const h=document.createElement("h4"); h.textContent=(cat.sectionLabel||cat.name)+" — "+(data.copy?.closingLead || "You may also add:"); sec.append(h);
    ups.forEach(x=>{
      const row=document.createElement("div"); row.className="item";
      const ov = (enabled.get(x.id)?.overrides)||{};
      const label=document.createElement("div"); label.innerHTML="<strong>"+(x.publicLabel||x.name||x.id)+"</strong>";
      const qty=document.createElement("input"); qty.type="number"; qty.step=x.step||1; qty.min=x.minQty||0; qty.max=x.maxQty||99999; qty.value=0; qty.id="ups-extra-"+x.id;
      const price=document.createElement("div"); price.className="small";
      if(x.pricingMode==="hour_or_day"){
        const hr = ov.ratePerHourExVAT ?? x.ratePerHourExVAT || 0;
        const dr = ov.ratePerDayExVAT ?? x.ratePerDayExVAT || 0;
        const cap = ov.dayCapHours ?? x.dayCapHours || 8;
        price.textContent = "€"+hr+"/hour or €"+dr+"/day (cap "+cap+"h)";
      }else{
        const p = ov.priceExVAT ?? x.priceExVAT || 0;
        price.textContent = "€"+p+" / "+(x.unitName||"unit");
      }
      row.append(label, qty, price); sec.append(row);
    });
    closing.append(sec);
  });
  renderQuote(selected);
  $("closingTitle").textContent = data.copy?.closingTitle || "Optional add-ons before checkout";
}
function renderQuote(selected){
  const lines=priceLines(selected);
  const t=sumTotals(lines);
  const out=$("quoteOut");
  const rows=lines.map(l=> `<tr><td>${l.label}</td><td>${l.qty}</td><td>${l.unitName}</td><td>${l.basis}</td><td>€${Number(l.unitPrice).toFixed(2)}</td><td>€${l.exVAT.toFixed(2)}</td><td>€${l.vat.toFixed(2)}</td><td>€${l.incVAT.toFixed(2)}</td></tr>`).join("");
  out.innerHTML=`
    <h3>Summary (before final review)</h3>
    <table class="table"><thead><tr><th>Item</th><th>Qty</th><th>Unit</th><th>Basis</th><th>Unit Rate</th><th>Ex VAT</th><th>VAT</th><th>Inc VAT</th></tr></thead>
    <tbody>${rows || "<tr><td colspan='8' class='small'>No add-ons selected.</td></tr>"}</tbody></table>
    <div class="right" style="margin-top:8px">
      <div class="pill">Ex VAT: €${t.ex.toFixed(2)}</div>
      <div class="pill">VAT: €${t.vat.toFixed(2)}</div>
      <div class="pill">Inc VAT: €${t.inc.toFixed(2)}</div>
    </div>`;
}
function recalcWithUpsells(){
  const selected=collectSelected();
  (data.extras||[]).forEach(x=>{ const el=document.getElementById("ups-extra-"+x.id); if(el){ const v=Number(el.value||0); if(v>0) selected.push(Object.assign({}, x, {qty:v})); } });
  renderQuote(selected); const lines=priceLines(selected); const t=sumTotals(lines);
  $("totEx").textContent="Total ex VAT: €"+t.ex.toFixed(2);
  $("totVat").textContent="VAT: €"+t.vat.toFixed(2);
  $("totInc").textContent="Total inc VAT: €"+t.inc.toFixed(2);
}

/* ---------- Save/Load/Import/Export ---------- */
document.getElementById("save").onclick=()=>{ localStorage.setItem(DKEY, JSON.stringify(data)); saved(true); alert("Draft saved to this browser."); };
document.getElementById("load").onclick=()=>{ const raw=localStorage.getItem(DKEY); if(!raw) return alert("No draft found"); const obj=JSON.parse(raw); Object.keys(data).forEach(k=>delete data[k]); Object.assign(data,obj); init(); saved(true); alert("Draft loaded."); };
document.getElementById("clear").onclick=()=>{ localStorage.removeItem(DKEY); saved(false); alert("Draft cleared."); };
document.getElementById("importJSON").onclick=()=>{ const f=document.createElement("input"); f.type="file"; f.accept="application/json"; f.onchange=async()=>{ const t=await f.files[0].text(); const obj=JSON.parse(t); Object.keys(data).forEach(k=>delete data[k]); Object.assign(data,obj); init(); saved(true); }; f.click(); };
document.getElementById("exportJSON").onclick=()=>{ const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="venue-tranche4a1-spaces-hotfix.json"; a.click(); URL.revokeObjectURL(url); };

/* ---------- Init ---------- */
function buildRoomSelectAndUI(){ buildRoomSelect(); buildSections(); }
function init(){
  ensureAtLeastOneRoom();
  document.getElementById("vatRate").value = data.vatRate||0;
  document.getElementById("copyClosingTitle").value=data.copy?.closingTitle||"";
  document.getElementById("copyClosingLead").value=data.copy?.closingLead||"";
  renderRooms(); renderCategories(); buildRoomSelectAndUI(); updatePreview(); calcTotalsLive();
}

/* Bind add-room safely even if cached */
document.addEventListener("DOMContentLoaded", ()=>{
  const btn=document.getElementById("addRoomBtn");
  if(btn){ btn.onclick=()=>{
    (data.rooms=data.rooms||[]).push({
      id:"RM-"+Math.random().toString(36).slice(2,6).toUpperCase(),
      name:"New Room", description:"",
      sizeSqm:0, floor:"",
      layouts: defaultLayouts(), features: defaultFeatures(),
      images:{hero:"", gallery:[]},
      constraints: defaultConstraints(), blackouts:[],
      includedItems:[], assignedExtras:[]
    });
    renderRooms(); buildRoomSelect(); updatePreview();
  }; }
  init();
});
</script>
</body>
</html>

