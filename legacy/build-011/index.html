
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>[R003k] Admin — Rooms + Categories (with Add‑ons)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#fff;--ink:#0f172a;--mut:#64748b;--bd:#e5e7eb;--brand:#0ea5e9;--ok:#16a34a;--warn:#f59e0b;--danger:#dc2626}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.wrap{max-width:1600px;margin:0 auto;padding:16px}
header{position:sticky;top:0;background:linear-gradient(180deg,#fff,rgba(255,255,255,.9));backdrop-filter:blur(6px);border-bottom:1px solid var(--bd);z-index:5}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.spacer{flex:1}
.btn{border:1px solid var(--bd);border-radius:10px;background:#fff;padding:8px 12px;cursor:pointer;font-weight:600}
.btn.small{padding:6px 10px;font-size:.9rem}.btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}.btn.danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
.pill{padding:4px 8px;border:1px solid var(--bd);border-radius:999px;font-size:12px;background:#fff}
.card{background:#fff;border:1px solid var(--bd);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04);margin:16px 0}
.card-h{padding:12px 16px;border-bottom:1px solid var(--bd);display:flex;gap:8px;align-items:center}.card-c{padding:16px}
nav.tabs{display:flex;gap:8px;flex-wrap:wrap;padding:8px 0;border-bottom:1px solid var(--bd);position:sticky;top:64px;background:#fff;z-index:4}
nav.tabs button{all:unset;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600;color:#475569}
nav.tabs button.active{background:#f1f5f9;color:#0f172a}
.section{display:none}.section.active{display:block}
.grid{display:grid;gap:12px}.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}.grid-auto{grid-template-columns:repeat(auto-fit,minmax(360px,1fr))}
table{width:100%;border-collapse:collapse}th,td{border:1px solid var(--bd);padding:8px;text-align:left;font-size:13px}
.help{color:var(--mut);font-size:.9rem}.banner{background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;border-radius:12px;padding:10px 12px;margin-top:12px}
.warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412;border-radius:12px;padding:10px 12px;margin-top:12px}
input,select,textarea{width:100%;border:1px solid var(--bd);border-radius:10px;padding:10px}
textarea{min-height:96px}
.empty{background:#f8fafc;border:1px dashed var(--bd);border-radius:12px;padding:18px}
.features-wrap{background:#f8fafc;padding:16px;border-radius:12px}
.features-cols{display:grid;grid-template-columns:repeat(4,1fr);gap:6px 18px}
.features-col{display:flex;flex-direction:column;gap:6px}.feature{display:flex;gap:8px;align-items:center;font-size:13px;line-height:1.15}
.features-tools{display:flex;gap:8px;align-items:center;margin-top:10px;justify-content:flex-end}
@media(max-width:1200px){.features-cols{grid-template-columns:repeat(2,1fr)}.features-tools{justify-content:flex-start}}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;padding:16px}
.modal .box{background:#fff;border-radius:12px;border:1px solid var(--bd);max-width:820px;width:100%;padding:16px}
textarea.paste{min-height:240px}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <strong>[R003k] Admin</strong>
    <span class="pill" id="counts">Rooms: 0 | Categories: 0 | Fix: 0</span>
    <div class="spacer"></div>
    <label class="btn small">Import JSON<input id="importFile" type="file" accept="application/json" style="display:none"></label>
    <button class="btn small" id="importPaste">Paste JSON</button>
    <button class="btn small" id="clearDraft">Clear draft</button>
    <button class="btn small primary" id="exportBtn">Export JSON</button>
    <button class="btn small" id="runGuard">Run self‑check</button>
  </div>
</header>

<main class="wrap">
  <div class="card warn" id="guardBanner" style="display:none"></div>

  <div class="card">
    <div class="card-h"><b>Admin</b><span class="pill">Rooms + Categories (Add‑ons) + Fix Log</span></div>
    <div class="card-c">
      <nav class="tabs">
        <button data-tab="rooms" class="active">1) Rooms</button>
        <button data-tab="categories">2) Categories</button>
        <button data-tab="pricing">3) Pricing & Fees</button>
        <button data-tab="fixlog">4) Fix Log</button>
        <button data-tab="preview">5) Preview</button>
      </nav>

      <!-- ROOMS (unchanged from j) -->
      <div id="rooms" class="section active">
        <div class="row" style="margin-bottom:8px">
          <input id="roomSearch" placeholder="Search rooms by name…" style="max-width:360px">
          <div class="spacer"></div>
          <button class="btn" id="addRoom">Add room</button>
        </div>
        <div id="roomsEmpty" class="empty" style="display:none">
          <b>No rooms</b><div class="help">Use <b>Import JSON</b> to load your data, or click <b>Add room</b>.</div>
        </div>
        <div class="grid grid-auto" id="roomsWrap"></div>
      </div>

      <!-- CATEGORIES with ITEMS (Add‑ons) -->
      <div id="categories" class="section">
        <div class="row"><button class="btn" id="addCat">Add category</button><button class="btn" id="seed">Seed AV + F&B</button></div>
        <div class="help" style="margin-top:6px">Each category can have <b>items (add‑ons)</b>. “Inclusive” = free by default; otherwise priced by simple amount or hour/day. <i>These appear to bookers at the end of their selection.</i></div>
        <div id="catWrap"></div>
      </div>

      <!-- PRICING -->
      <div id="pricing" class="section">
        <div class="grid grid-3">
          <div><label>Currency</label><input id="cur" value="EUR"></div>
          <div><label>VAT defaults (JSON)</label><textarea id="vatDefaults" placeholder='{"room":0,"fnb":23,"av":23,"staff":23}'></textarea></div>
          <div><label>Rounding step</label><input id="rounding" type="number" step="0.01" value="0.01"></div>
          <div><label>Service charge %</label><input id="svc" type="number" step="0.1" value="0"></div>
          <div><label>Deposit %</label><input id="dep" type="number" step="0.1" value="25"></div>
          <div><label>Out‑of‑hours surcharge %</label><input id="ooh" type="number" step="0.1" value="0"></div>
          <div><label><b>VAT rate %</b></label><input id="vatRate" type="number" step="0.1" placeholder="e.g., 23"></div>
        </div>
      </div>

      <!-- FIX LOG -->
      <div id="fixlog" class="section">
        <div class="row" style="gap:8px">
          <input id="log_title" placeholder="New item title…" style="max-width:420px">
          <select id="log_area"><option>Rooms</option><option>Rooms: Layouts</option><option>Rooms: Features</option><option>Categories</option><option>Pricing</option><option>Preview</option><option>Global</option></select>
          <button class="btn small" id="log_add">Add</button>
          <div class="spacer"></div>
          <input id="log_filter" placeholder="Search/filter…" style="max-width:320px">
        </div>
        <div id="log_list" style="margin-top:12px;display:grid;gap:10px"></div>
      </div>

      <!-- PREVIEW -->
      <div id="preview" class="section"><pre id="dump" style="white-space:pre-wrap"></pre></div>
    </div>
  </div>
</main>

<!-- Paste modal -->
<div class="modal" id="pasteModal">
  <div class="box">
    <div class="row"><b>Paste JSON to import</b><div class="spacer"></div><button class="btn small" id="closePaste">Close</button></div>
    <textarea id="pasteArea" class="paste" placeholder="Paste your JSON here…"></textarea>
    <div class="row" style="margin-top:8px"><div class="spacer"></div><button class="btn primary" id="doPaste">Import</button></div>
  </div>
</div>

<script>
(function(){
  const $=id=>document.getElementById(id);
  const KEY="admin_draft_v2";
  let state = load() || { rooms:[], categories:[], pricing:{ currency:"EUR", vatDefaults:{room:0,fnb:23,av:23,staff:23}, rounding:0.01, serviceChargePct:0 }, fees:{ depositPct:25, outOfHoursSurchargePct:0 }, vatRate:23, fixLog:[] };

  function save(){ try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){} updateCounts(); renderPreview(); }
  function load(){ try{ const raw=localStorage.getItem(KEY); return raw? JSON.parse(raw): null; }catch(e){ return null; } }
  function updateCounts(){ $("counts").textContent = `Rooms: ${(state.rooms||[]).length} | Categories: ${(state.categories||[]).length} | Fix: ${(state.fixLog||[]).length}`; }

  // Tabs
  document.querySelectorAll("nav.tabs button").forEach(btn=>btn.addEventListener("click",()=>{
    document.querySelectorAll("nav.tabs button").forEach(b=>b.classList.remove("active")); btn.classList.add("active");
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active")); $(btn.dataset.tab).classList.add("active");
  }));

  // Import/Export/Clear/Paste
  $("importFile").addEventListener("change",(ev)=>{ const f=ev.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result||"{}"); migrate(data); state=data; renderAll(); save(); alert("Import complete ✔"); }catch(e){ alert("Invalid JSON"); } ev.target.value=""; }; r.readAsText(f); });
  $("exportBtn").onclick=()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.download="admin-data.json"; a.href=URL.createObjectURL(blob); document.body.appendChild(a); a.click(); a.remove(); };
  $("clearDraft").onclick=()=>{ localStorage.removeItem(KEY); state={ rooms:[], categories:[], pricing:{ currency:"EUR", vatDefaults:{room:0,fnb:23,av:23,staff:23}, rounding:0.01 }, fees:{ depositPct:25, outOfHoursSurchargePct:0 }, vatRate:23, fixLog:[] }; renderAll(); save(); };
  $("importPaste").onclick=()=>{ $("pasteModal").style.display="flex"; };
  $("closePaste").onclick=()=>{ $("pasteModal").style.display="none"; };
  $("doPaste").onclick=()=>{ try{ const data=JSON.parse($("pasteArea").value||"{}"); migrate(data); state=data; renderAll(); save(); $("pasteModal").style.display="none"; alert("Import complete ✔"); }catch(e){ alert("Invalid JSON"); } };

  // Rooms (kept simple for focus on categories/items)
  $("addRoom").onclick=()=>{ const rm={ id:"RM-"+Math.random().toString(36).slice(2,7).toUpperCase(), name:"", description:"", categoryId:(state.categories[0]||{}).id||"", layouts:[{type:"Boardroom",capacity:0,default:true}], features:{}, customFeatures:[], baseRates:{perHourExVAT:0,perHalfDayExVAT:0,perDayExVAT:0,minDurationMins:60,earliestStart:"07:00",latestEnd:"22:00"} }; state.rooms.push(rm); renderRooms(); save(); };
  $("roomSearch").addEventListener("input",renderRooms);

  function titleCase(s){ return String(s||"").toLowerCase().replace(/\s+/g," ").replace(/(^|\s)\S/g, a=>a.toUpperCase()); }

  function renderRooms(){
    const w=$("roomsWrap"); w.innerHTML="";
    const q=String($("roomSearch").value||"").toLowerCase();
    const arr=state.rooms||[]; $("roomsEmpty").style.display=arr.length?"none":"block";
    arr.forEach((r,i)=>{
      if(q && String(r.name||"").toLowerCase().indexOf(q)===-1) return;
      const div=document.createElement("div"); div.className="card"; div.innerHTML=`
        <div class="card-c grid grid-2">
          <div><label>Room name</label><input id="rn-${i}" value="${r.name||""}"></div>
          <div><label>Category</label><select id="rc-${i}"></select></div>
        </div>
        <div class="card-c"><label>Description</label><textarea id="rd-${i}" placeholder="Short description…">${r.description||""}</textarea></div>
        <div class="card-c"><b>Layouts (summary)</b><div class="help">${(r.layouts||[]).map(L=>`${L.type}: ${L.capacity}`).join(" • ")}</div></div>
      `;
      w.appendChild(div);
      const sel=$("rc-"+i); sel.innerHTML="<option value=''>—</option>"+(state.categories||[]).map(c=>`<option value="${c.id}">${c.name||c.id}</option>`).join(""); sel.value=r.categoryId||""; sel.onchange=e=>{ r.categoryId=e.target.value; save(); };
      $("rn-"+i).oninput=e=>{ r.name=e.target.value; save(); };
      $("rd-"+i).oninput=e=>{ r.description=e.target.value; save(); };
    });
  }

  // Categories + Items (Add‑ons)
  $("addCat").onclick=()=>{ state.categories.push({id:"CAT-"+Math.random().toString(36).slice(2,6).toUpperCase(),name:"New Category",sectionLabel:"",sort:(state.categories.length+1)*10,showClosingUpsell:true,items:[]}); renderCats(); save(); };
  $("seed").onclick=()=>{
    if(!state.categories.some(c=>c.id==="CAT-FNB")){
      state.categories.push({id:"CAT-FNB",name:"Food & Beverage",sectionLabel:"F&B",sort:10,showClosingUpsell:true,items:[
        {id:"ITM-COF",name:"Coffee & Tea (refills)",publicLabel:"Coffee & Tea",inclusive:false,pricingMode:"simple",priceType:"per_person",unitName:"person",priceExVAT:4.5,taxable:true,step:1}
      ]});
    }
    if(!state.categories.some(c=>c.id==="CAT-AV")){
      state.categories.push({id:"CAT-AV",name:"Audio/Visual",sectionLabel:"AV",sort:20,showClosingUpsell:true,items:[
        {id:"ITM-PTZ",name:"PTZ Camera Kit",publicLabel:"PTZ Camera Kit",inclusive:false,pricingMode:"hour_or_day",ratePerHourExVAT:60,ratePerDayExVAT:180,dayCapHours:4,roundHoursUp:true,taxable:true}
      ]});
    }
    renderCats(); save();
  };

  function renderCats(){
    const w=$("catWrap"); w.innerHTML="";
    state.categories.sort((a,b)=>(a.sort||0)-(b.sort||0)).forEach((c,ci)=>{
      const sec=document.createElement("div"); sec.className="card";
      sec.innerHTML=`
        <div class="card-h"><b>${c.sectionLabel||c.name||"Category"}</b><span class="pill">${c.id}</span></div>
        <div class="card-c grid grid-3">
          <div><label>Display name</label><input id="cname-${ci}" value="${c.name||""}"></div>
          <div><label>Section label (short)</label><input id="clab-${ci}" value="${c.sectionLabel||""}" placeholder="e.g., AV"></div>
          <div><label>Category ID</label><input id="cid-${ci}" value="${c.id||""}"></div>
          <div><label>Sort (ascending)</label><input id="csort-${ci}" type="number" step="1" value="${c.sort||0}"></div>
          <div><label>Show closing upsell?</label><select id="cupsell-${ci}"><option ${c.showClosingUpsell?"selected":""} value="true">Yes</option><option ${!c.showClosingUpsell?"selected":""} value="false">No</option></select></div>
        </div>
        <div class="card-c">
          <div class="row" style="align-items:center"><b>Items (Add‑ons)</b><div class="spacer"></div><button class="btn small" id="ai-${ci}">Add item</button></div>
          <table class="table" style="margin-top:8px">
            <thead><tr><th>Inclusive</th><th>Name</th><th>Mode</th><th>Type</th><th>Unit</th><th>Price ex VAT</th><th>Rate/hr</th><th>Rate/day</th><th>Cap hrs</th><th>Round up?</th><th>Taxable</th><th></th></tr></thead>
            <tbody id="tb-${ci}"></tbody>
          </table>
        </div>
      `;
      w.appendChild(sec);

      // Bind cat fields
      $("cname-"+ci).oninput=e=>{ c.name=e.target.value; save(); };
      $("clab-"+ci).oninput=e=>{ c.sectionLabel=e.target.value; save(); };
      $("cid-"+ci).oninput=e=>{ c.id=e.target.value; save(); };
      $("csort-"+ci).oninput=e=>{ c.sort=Number(e.target.value||0); save(); };
      $("cupsell-"+ci).onchange=e=>{ c.showClosingUpsell=(e.target.value==="true"); save(); };

      $("ai-"+ci).onclick=()=>{
        c.items=c.items||[];
        c.items.push({ id:"ITM-"+Math.random().toString(36).slice(2,6).toUpperCase(), name:"New add‑on", publicLabel:"", inclusive:false, pricingMode:"simple", priceType:"per_item", unitName:"item", priceExVAT:0, ratePerHourExVAT:0, ratePerDayExVAT:0, dayCapHours:0, roundHoursUp:false, taxable:true, step:1 });
        renderCats(); save();
      };

      const tb=$("tb-"+ci);
      (c.items||[]).forEach((it,ii)=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td><input type="checkbox" id="inc-${ci}-${ii}" ${it.inclusive?"checked":""}></td>
          <td><input id="nm-${ci}-${ii}" value="${it.name||""}" placeholder="Internal name"></td>
          <td>
            <select id="mode-${ci}-${ii}">
              <option ${it.pricingMode==="simple"?"selected":""} value="simple">simple</option>
              <option ${it.pricingMode==="hour_or_day"?"selected":""} value="hour_or_day">hour_or_day</option>
            </select>
          </td>
          <td>
            <select id="type-${ci}-${ii}">
              <option ${it.priceType==="per_item"?"selected":""} value="per_item">per_item</option>
              <option ${it.priceType==="per_person"?"selected":""} value="per_person">per_person</option>
            </select>
          </td>
          <td><input id="unit-${ci}-${ii}" value="${it.unitName||""}" placeholder="item/person"></td>
          <td><input type="number" step="0.01" id="price-${ci}-${ii}" value="${it.priceExVAT||0}"></td>
          <td><input type="number" step="0.01" id="rateh-${ci}-${ii}" value="${it.ratePerHourExVAT||0}"></td>
          <td><input type="number" step="0.01" id="rated-${ci}-${ii}" value="${it.ratePerDayExVAT||0}"></td>
          <td><input type="number" step="1" id="cap-${ci}-${ii}" value="${it.dayCapHours||0}"></td>
          <td><input type="checkbox" id="round-${ci}-${ii}" ${it.roundHoursUp?"checked":""}></td>
          <td><input type="checkbox" id="tax-${ci}-${ii}" ${it.taxable!==false?"checked":""}></td>
          <td><button class="btn small danger" id="del-${ci}-${ii}">Remove</button></td>
        `;
        tb.appendChild(tr);
        $("inc-"+ci+"-"+ii).onchange=e=>{ it.inclusive=e.target.checked; save(); };
        $("nm-"+ci+"-"+ii).oninput=e=>{ it.name=e.target.value; save(); };
        $("mode-"+ci+"-"+ii).onchange=e=>{ it.pricingMode=e.target.value; save(); };
        $("type-"+ci+"-"+ii).onchange=e=>{ it.priceType=e.target.value; save(); };
        $("unit-"+ci+"-"+ii).oninput=e=>{ it.unitName=e.target.value; save(); };
        $("price-"+ci+"-"+ii).oninput=e=>{ it.priceExVAT=Number(e.target.value||0); save(); };
        $("rateh-"+ci+"-"+ii).oninput=e=>{ it.ratePerHourExVAT=Number(e.target.value||0); save(); };
        $("rated-"+ci+"-"+ii).oninput=e=>{ it.ratePerDayExVAT=Number(e.target.value||0); save(); };
        $("cap-"+ci+"-"+ii).oninput=e=>{ it.dayCapHours=parseInt(e.target.value||0,10)||0; save(); };
        $("round-"+ci+"-"+ii).onchange=e=>{ it.roundHoursUp=e.target.checked; save(); };
        $("tax-"+ci+"-"+ii).onchange=e=>{ it.taxable=e.target.checked; save(); };
        $("del-"+ci+"-"+ii).onclick=()=>{ c.items.splice(ii,1); renderCats(); save(); };
      });
    });
  }

  // Pricing
  function renderPricing(){
    const p=state.pricing||(state.pricing={currency:"EUR",vatDefaults:{room:0,fnb:23,av:23,staff:23},rounding:0.01,serviceChargePct:0});
    const f=state.fees||(state.fees={depositPct:25,outOfHoursSurchargePct:0});
    $("cur").value=p.currency||"EUR"; $("vatDefaults").value=JSON.stringify(p.vatDefaults||{},null,2); $("rounding").value=p.rounding??0.01; $("svc").value=p.serviceChargePct??0; $("dep").value=f.depositPct??25; $("ooh").value=f.outOfHoursSurchargePct??0; $("vatRate").value=state.vatRate??0;
    $("cur").oninput=e=>{ p.currency=e.target.value; save(); };
    $("vatDefaults").oninput=e=>{ try{ p.vatDefaults=JSON.parse(e.target.value||"{}"); e.target.style.borderColor="var(--bd)"; }catch{ e.target.style.borderColor="var(--danger)"; } save(); };
    $("rounding").oninput=e=>{ p.rounding=+e.target.value||0.01; save(); };
    $("svc").oninput=e=>{ p.serviceChargePct=+e.target.value||0; save(); };
    $("dep").oninput=e=>{ f.depositPct=+e.target.value||0; save(); };
    $("ooh").oninput=e=>{ f.outOfHoursSurchargePct=+e.target.value||0; save(); };
    $("vatRate").oninput=e=>{ state.vatRate=+e.target.value||0; save(); };
  }

  // Fix Log
  $("log_add").onclick=()=>{ const t=$("log_title").value.trim(); const a=$("log_area").value; if(!t) return; state.fixLog=state.fixLog||[]; state.fixLog.unshift({id:"FIX-"+Math.random().toString(36).slice(2,8).toUpperCase(),title:t,area:a,status:"Open",createdAt:new Date().toISOString()}); save(); renderLog(); $("log_title").value=""; };
  $("log_filter").addEventListener("input",renderLog);
  function renderLog(){ const list=$("log_list"); list.innerHTML=""; const q=String($("log_filter").value||"").toLowerCase(); (state.fixLog||[]).filter(it=>!q||JSON.stringify(it).toLowerCase().includes(q)).forEach((it,ix)=>{ const card=document.createElement("div"); card.className="card"; card.innerHTML=`<div class="card-c"><div class="row"><b>${it.title||""}</b><span class="pill">${it.area||"Global"}</span><div class="spacer"></div><select id="ls-${ix}"><option ${it.status==="Open"?"selected":""}>Open</option><option ${it.status==="Resolved"?"selected":""}>Resolved</option></select><button class="btn small danger" id="ldel-${ix}">Delete</button></div><div class="mut" style="margin-top:6px">${new Date(it.createdAt||Date.now()).toLocaleString()}</div></div>`; list.appendChild(card); $("ls-"+ix).onchange=e=>{ it.status=e.target.value; save(); }; $("ldel-"+ix).onclick=()=>{ if(confirm("Delete this log entry?")){ state.fixLog.splice(ix,1); save(); renderLog(); } }; }); }

  // Guard
  const CONTRACT=[
    {key:"#roomsWrap",label:"Rooms list renders"},
    {key:"#catWrap",label:"Categories list renders"}
  ];
  function runGuard(){
    const fails=CONTRACT.filter(c=>!document.querySelector(c.key));
    const b=$("guardBanner"); if(fails.length){ b.style.display="block"; b.className="card warn"; b.innerHTML="<b>Self‑check:</b> missing parts:<ul style='margin:6px 0 0 18px'>"+fails.map(f=>`<li>${f.label}</li>`).join("")+"</ul>"; } else { b.style.display="block"; b.className="card banner"; b.textContent="Self‑check passed: key sections present."; }
  }
  $("runGuard").onclick=runGuard;

  function migrate(data){
    if(!data||typeof data!=="object") data={};
    if(!Array.isArray(data.rooms)) data.rooms=[];
    if(!Array.isArray(data.categories)) data.categories=[];
    data.pricing=data.pricing||{currency:"EUR",vatDefaults:{room:0,fnb:23,av:23,staff:23},rounding:0.01,serviceChargePct:0};
    data.fees=data.fees||{depositPct:25,outOfHoursSurchargePct:0};
    data.vatRate=typeof data.vatRate==="number"?data.vatRate:23;
    // Normalize categories/items
    data.categories.forEach(c=>{ if(!Array.isArray(c.items)) c.items=[]; c.sort = c.sort ?? 0; c.showClosingUpsell = c.showClosingUpsell !== false; });
  }

  function renderPreview(){ $("dump").textContent=JSON.stringify(state,null,2); }
  function renderAll(){ renderRooms(); renderCats(); renderPricing(); renderLog(); renderPreview(); updateCounts(); runGuard(); }
  renderAll();
})();
</script>
</body>
</html>
